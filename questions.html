<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è³ªå•ä¸€è¦§</title>
  <link rel="stylesheet" href="questions.css">
</head>
<body>

<div id="top-menu">
  <header class="top-bar">
    <div class="user-info">
      <span id="user-id">ID : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      <span id="user-points">ãƒã‚¤ãƒ³ãƒˆ : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
    </div>
  </header>

  <div class="container">
    <h2 id="topic-title">æŠ•ç¨¿ã•ã‚ŒãŸè³ªå•</h2>

    <!-- æ¤œç´¢çª“ + ãƒœã‚¿ãƒ³ -->
    <div>
      <input type="text" id="searchBox" placeholder="è³ªå•ã‚’æ¤œç´¢" />
      <button id="searchButton">æ¤œç´¢</button>
      <button id="clearSearchButton">æ¤œç´¢è§£é™¤</button>
    </div>
    <ul id="results"></ul>

    <!-- è³ªå•æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="post-form" id="post-form">
      <h2>æ–°ã—ã„è³ªå•ã‚’æŠ•ç¨¿</h2>
      <input type="text" id="new-title" placeholder="è³ªå•ã®ã‚¿ã‚¤ãƒˆãƒ«" />
      <textarea id="new-content" placeholder="è³ªå•å†…å®¹"></textarea>
      <button id="post-question">æŠ•ç¨¿ã™ã‚‹</button>
    </div>

    <!-- è³ªå•ä¸€è¦§ -->
    <div class="question-container">
      <h2>æŠ•ç¨¿ã•ã‚ŒãŸè³ªå•</h2>
      <div id="question-list">èª­ã¿è¾¼ã¿ä¸­...</div>
      <button id="load-more" style="display: none;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </div>

    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="go-top-detail">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { 
  getFirestore, collection, doc, setDoc, getDoc, query, where, orderBy, getDocs, startAfter, limit, serverTimestamp, onSnapshot, updateDoc, increment 
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

const firebaseConfig = {
      apiKey: "AIzaSyAgZdnJ9Tptevqoa0S46T8FxNC2zKnK7rE",
      authDomain: "my-memory-1acf4.firebaseapp.com",
      projectId: "my-memory-1acf4",
      storageBucket: "my-memory-1acf4.firebasestorage.app",
      messagingSenderId: "125628430923",
      appId: "1:125628430923:web:34b102c15d05cfb924ebce"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const postForm = document.getElementById("post-form");
const userIdElem = document.getElementById("user-id");
const userPointsElem = document.getElementById("user-points");
const questionList = document.getElementById("question-list");
const loadMoreBtn = document.getElementById("load-more");
const clearSearchBtn = document.getElementById("clearSearchButton");

let currentUserUID = null;
let lastVisible = null;
const pageSize = 5;

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯å–å¾—
const params = new URLSearchParams(window.location.search);
const topic = params.get("topic") || "math";

const topicMap = { 
  japanese: "å›½èª", math: "æ•°å­¦", science: "ç†ç§‘", socialStudies: "ç¤¾ä¼š", english: "è‹±èª", otherSubjects: "ãã®ä»–ã®æ•™ç§‘", inquiry:"æ¢ç©¶",
  personality: "æ€§æ ¼", emotion: "æ„Ÿæƒ…", 
  lifestyle: "ç”Ÿæ´»ç¿’æ…£", physicalCondition: "ä½“èª¿ç®¡ç†", 
  schoolLife: "å­¦æ ¡ç”Ÿæ´»", relationship: "äººé–“é–¢ä¿‚", 
  college: "å¤§å­¦", exam: "å—é¨“"
};

// ãƒˆãƒ”ãƒƒã‚¯è¡¨ç¤º
document.getElementById("topic-title").textContent = `${topicMap[topic] || topic}ã«ã¤ã„ã¦ã®è³ªå•ä¸€è¦§`;

// ãƒˆãƒ”ãƒƒã‚¯ â†’ å¤§åˆ†é¡ãƒãƒƒãƒ”ãƒ³ã‚°
const categoryMap = {
  japanese: "study", math: "study", english: "study", science: "study", socialStudies: "study", inquiry:"study", otherSubjects: "study",
  personality: "mind", emotion: "mind",
  lifestyle: "health", physicalCondition: "health",
  schoolLife: "society", relationship: "society",
  college: "career", exam: "career"
};

// ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
onAuthStateChanged(auth, (user) => {
  if (!user) { window.location.href="index.html"; return; }
  currentUserUID = user.uid;

  const userDocRef = doc(db, "users", currentUserUID);
  onSnapshot(userDocRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      userIdElem.textContent = `ID : ${data.userID || "ä¸æ˜"}`;
      userPointsElem.textContent = `ãƒã‚¤ãƒ³ãƒˆ : ${data.points || 0}`;
    } else {
      userIdElem.textContent = "ID : ãƒ‡ãƒ¼ã‚¿ãªã—";
      userPointsElem.textContent = "ãƒã‚¤ãƒ³ãƒˆ : ãƒ‡ãƒ¼ã‚¿ãªã—";
    }
  });
});

// ğŸ“ è³ªå•æŠ•ç¨¿
document.getElementById("post-question").addEventListener("click", async () => {
  const title = document.getElementById("new-title").value.trim();
  const content = document.getElementById("new-content").value.trim();
  if (!title || !content) { alert("å…¨ã¦ã®æ¬„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if (!currentUserUID) { alert("ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“"); return; }

  const docRef = doc(collection(db, "questions"));
  await setDoc(docRef, { 
    uid: docRef.id, 
    userUID: currentUserUID, 
    title, 
    content, 
    topic, 
    timestamp: serverTimestamp(), 
    answerCount: 0 
  });

  // ãƒã‚¤ãƒ³ãƒˆåŠ ç®—å‡¦ç†
  const category = categoryMap[topic];
  if (category) {
    try {
      await updateDoc(doc(db,"users",currentUserUID), {
        [`q_${category}`]: increment(1),
        points: increment(3)
      });
    } catch(e) {
      console.error("ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã‚¨ãƒ©ãƒ¼:",e);
    }
  }

  alert("è³ªå•ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
  location.reload();
});

// ğŸ” è³ªå•å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
async function loadQuestions() {
  const q = lastVisible
    ? query(collection(db,"questions"), where("topic","==",topic), orderBy("timestamp","desc"), startAfter(lastVisible), limit(pageSize))
    : query(collection(db,"questions"), where("topic","==",topic), orderBy("timestamp","desc"), limit(pageSize));

  const snapshot = await getDocs(q);
  if (snapshot.empty && !lastVisible) { questionList.innerHTML="<p>ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</p>"; loadMoreBtn.style.display="none"; return; }

  const questions = snapshot.docs.map(docSnap => {
    const data = docSnap.data();
    data.answerCount = data.answerCount || 0;
    return data;
  });

  displayQuestions(questions, lastVisible===null);
  lastVisible = snapshot.docs[snapshot.docs.length-1];
  loadMoreBtn.style.display = snapshot.docs.length<pageSize?"none":"block";
}

// ğŸ“„ è³ªå•è¡¨ç¤º
function displayQuestions(questions,isFirstPage=false){
  if(isFirstPage) questionList.innerHTML="";
  questions.forEach(data=>{
    const { uid, title, content, timestamp, answerCount } = data;
    const time = timestamp?.toDate?.().toLocaleDateString("ja-JP") || "æ—¥æ™‚ä¸æ˜";
    const link = document.createElement("a");
    link.href = `question.html?id=${uid}`;
    link.classList.add("question-box");
    link.innerHTML = `<strong>${title}</strong><p>${content}</p><small>${time} | å›ç­”æ•° : ${answerCount}</small>`;
    questionList.appendChild(link);
  });
}

// ğŸ” Algolia æ¤œç´¢ + ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
const client = algoliasearch('2JACQDV4QE', 'af805841b2009f177c0f3b80b38aa182');
const index = client.initIndex('questions');

let searchResults = [];
let currentIndex = 0;
const searchPageSize = 5;

async function performSearch(queryText){
  const result = await index.search(queryText,{filters:`topic:"${topic}"`});
  const hits = result.hits;
  searchResults = await Promise.all(hits.map(async hit=>{
    const snap = await getDoc(doc(db,"questions",hit.objectID));
    if(!snap.exists()) return null;
    const data = snap.data();
    data.answerCount = data.answerCount || 0;
    return data;
  }));
  searchResults = searchResults.filter(Boolean);
  currentIndex=0;
  questionList.innerHTML="";
  displaySearchResults();
  clearSearchBtn.style.display = "inline-block";
}

function displaySearchResults(){
  const slice = searchResults.slice(currentIndex,currentIndex+searchPageSize);
  displayQuestions(slice,currentIndex===0);
  currentIndex += slice.length;
  loadMoreBtn.style.display = currentIndex<searchResults.length?"block":"none";
}

// ğŸ” æ¤œç´¢ãƒœã‚¿ãƒ³
document.getElementById('searchButton').addEventListener('click', ()=>{
  const queryText = document.getElementById('searchBox').value.trim();
  if(queryText===''){ resetSearch(); return; }
  postForm.style.display="none";
  performSearch(queryText);
});

// ğŸ”„ æ¤œç´¢è§£é™¤ãƒœã‚¿ãƒ³
function resetSearch(){
  document.getElementById('searchBox').value = "";
  lastVisible=null; 
  questionList.innerHTML="èª­ã¿è¾¼ã¿ä¸­..."; 
  loadMoreBtn.style.display="none"; 
  postForm.style.display="block"; 
  clearSearchBtn.style.display="none"; 
  loadQuestions(); 
}

clearSearchBtn.addEventListener('click', resetSearch);

// ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³
loadMoreBtn.addEventListener("click", ()=>{
  if(searchResults.length>0) displaySearchResults();
  else loadQuestions();
});

// ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
document.getElementById("go-top-detail").addEventListener("click",()=>{
  window.location.href="top.html";
});

// åˆæœŸè¡¨ç¤º
loadQuestions();
</script>
</body>
</html>
