<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒˆãƒƒãƒ—ç”»é¢</title>
  <link rel="stylesheet" href="top.css">
</head>
<body>
  <header class="top-bar">
    <div class="user-info">
      <span id="user-id">ID : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      <span id="user-points">ãƒã‚¤ãƒ³ãƒˆ : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      <div class="user-stats" id="user-stats">èª­ã¿è¾¼ã¿ä¸­</div>
    </div>
    <button id="logout-btn" style="
      margin-left: 20px;
      margin-right: 30px;
      padding:5px 10px;
      background-color:#f44336;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
    ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <div id="top-menu">
    <div class="main-content">
      <section class="questions">
        <h2>ç­”ãˆã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</h2>
        <ul id="questionList"></ul>
      </section>
      <section class="answered-questions">
        <h2>å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯</h2>
        <ul id="answeredQuestions"></ul>
      </section>
    </div>

    <div class="topics-container">
      <h2>ãƒˆãƒ”ãƒƒã‚¯ã§æ¢ã™</h2>
      <dl class="topics">
                <div class="topic-item">
          <dt class="topic" data-topic="study">ğŸ“š å­¦ç¿’</dt>
          <dd data-topic="study">ã‚ã‹ã‚‰ãªã„å•é¡Œãƒ»å‹‰å¼·æ³•ãªã©</dd>
        </div>
        <dd class="subtopics" id="study">
          <a href="questions.html?topic=japanese">å›½èª</a>
          <a href="questions.html?topic=math">æ•°å­¦</a>
          <a href="questions.html?topic=english">è‹±èª</a>
          <a href="questions.html?topic=science">ç†ç§‘</a>
          <a href="questions.html?topic=socialStudies">ç¤¾ä¼š</a>
          <a href="questions.html?topic=inquiry">æ¢ç©¶</a>
          <a href="questions.html?topic=otherSubjects">å‰¯æ•™ç§‘/ãã®ä»–</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="mind">ğŸ’­ å¿ƒç†</dt>
          <dd data-topic="mind">ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="mind">
          <a href="questions.html?topic=personality">æ€§æ ¼</a>
          <a href="questions.html?topic=emotion">æ„Ÿæƒ…</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="health">ğŸ’ª å¥åº·</dt>
          <dd data-topic="health">ç¡çœ ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="health">
          <a href="questions.html?topic=lifestyle">ç”Ÿæ´»ç¿’æ…£</a>
          <a href="questions.html?topic=physicalCondition">ä½“èª¿ç®¡ç†</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="society">ğŸ‘¤ ç¤¾ä¼š</dt>
          <dd data-topic="society">äººã¥ãã‚ã„ãƒ»å­¦æ ¡è¡Œäº‹ãªã©</dd>
        </div>
        <dd class="subtopics" id="society">
          <a href="questions.html?topic=schoolLife">å­¦æ ¡ç”Ÿæ´»</a>
          <a href="questions.html?topic=relationship">äººé–“é–¢ä¿‚</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="career">ğŸ« é€²è·¯</dt>
          <dd data-topic="career">é€²å­¦å…ˆã®æ¢ã—æ–¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="career">
          <a href="questions.html?topic=college">å¤§å­¦</a>
          <a href="questions.html?topic=exam">å—é¨“</a>
        </dd>
      </dl>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, doc, collection, query, where,
      orderBy, limit, getDocs, getDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAgZdnJ9Tptevqoa0S46T8FxNC2zKnK7rE",
      authDomain: "my-memory-1acf4.firebaseapp.com",
      projectId: "my-memory-1acf4",
      storageBucket: "my-memory-1acf4.firebasestorage.app",
      messagingSenderId: "125628430923",
      appId: "1:125628430923:web:34b102c15d05cfb924ebce"
     };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const userIdElem = document.getElementById("user-id");
    const userPointsElem = document.getElementById("user-points");
    const statsElem = document.getElementById("user-stats");
    const logoutBtn = document.getElementById("logout-btn");

    logoutBtn.addEventListener("click", async () => {
      await auth.signOut();
      window.location.href = "index.html";
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      const userUID = user.uid;
      const userRef = doc(db, "users", userUID);

      /* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ1å›èª­ã¿å–ã‚Šï¼‰ ===== */
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const data = userSnap.data();

        userIdElem.textContent = `ID : ${data.userID || "ä¸æ˜"}`;
        userPointsElem.textContent = `ãƒã‚¤ãƒ³ãƒˆ : ${data.points || 0}`;

        /* ===== ã“ã“ãŒè¿½åŠ ï¼šå¤‰æ•°è¡¨ç¤º ===== */
        const categories = ["study", "mind", "health", "society", "career"];
        const types = ["q", "a", "l"];

        const parts = [];
        categories.forEach(cat => {
          types.forEach(t => {
            const key = `${t}_${cat}`;
            parts.push(data[key] ?? 0);
          });
        });

        // q_study.a_study.l_study.q_mind... ã®é †ã§è¡¨ç¤º
        statsElem.textContent = parts.join(",");
      } else {
        statsElem.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
      }

      /* ===== è‡ªåˆ†ã®è³ªå•ï¼ˆæœ€æ–°3ä»¶ï¼‰ ===== */
      async function loadMyQuestions() {
        const elem = document.getElementById("answeredQuestions");
        const q = query(
          collection(db, "questions"),
          where("userUID", "==", userUID),
          orderBy("timestamp", "desc"),
          limit(3)
        );

        const snap = await getDocs(q);
        elem.innerHTML = "";

        if (snap.empty) {
          elem.innerHTML = "<li>ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“ã€‚</li>";
          return;
        }

        snap.forEach(d => {
          const a = document.createElement("a");
          a.href = `question.html?id=${d.id}`;
          a.className = "question-box";
          a.textContent = d.data().title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";

          const li = document.createElement("li");
          li.appendChild(a);
          elem.appendChild(li);
        });
      }

      /* ===== ç­”ãˆã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ ===== */
      async function loadUnansweredQuestions() {
        const listElem = document.getElementById("questionList");

        const q = query(
          collection(db, "questions"),
          where("answerCount", "<", 2),
          limit(15)
        );

        const snap = await getDocs(q);

        let candidates = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(q => q.userUID !== userUID);

        if (candidates.length === 0) {
          listElem.innerHTML = "<li>ç­”ãˆã¦ã»ã—ã„è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
          return;
        }

        candidates.sort((a, b) => a.answerCount - b.answerCount);

        const shuffle = arr => {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        };

        const ordered = [
          ...shuffle(candidates.filter(q => q.answerCount === 0)),
          ...shuffle(candidates.filter(q => q.answerCount === 1))
        ];

        listElem.innerHTML = "";
        ordered.slice(0, 5).forEach(q => {
          const a = document.createElement("a");
          a.href = `question.html?id=${q.id}`;
          a.className = "question-box";
          a.textContent = q.title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";

          const li = document.createElement("li");
          li.appendChild(a);
          listElem.appendChild(li);
        });
      }

      loadMyQuestions();
      loadUnansweredQuestions();
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".topic, dd[data-topic]").forEach(item => {
        item.addEventListener("click", () => {
          const sub = document.getElementById(item.dataset.topic);
          if (sub) sub.classList.toggle("show");
        });
      });
    });
  </script>
</body>
</html>
