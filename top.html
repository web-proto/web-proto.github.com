<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒˆãƒƒãƒ—ç”»é¢</title>
  <link rel="stylesheet" href="top.css">
</head>
<body>
  <header class="top-bar">
    <div class="user-info">
      <span id="user-id">ID : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      <span id="user-points">ãƒã‚¤ãƒ³ãƒˆ : èª­ã¿è¾¼ã¿ä¸­â€¦</span>
    </div>
    <button id="logout-btn" style="
      margin-left: 20px;
      margin-right: 30px;
      padding:5px 10px;
      background-color:#f44336;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
    ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <div id="top-menu">
    <div class="main-content">
      <section class="questions">
        <h2>ç­”ãˆã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</h2>
        <ul id="questionList"></ul>
      </section>
      <section class="answered-questions">
        <h2>å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯</h2>
        <ul id="answeredQuestions"></ul>
      </section>
    </div>

    <div class="topics-container">
      <h2>ãƒˆãƒ”ãƒƒã‚¯ã§æ¢ã™</h2>
      <dl class="topics">
        <div class="topic-item">
          <dt class="topic" data-topic="study">ğŸ“š å­¦ç¿’</dt>
          <dd data-topic="study">ã‚ã‹ã‚‰ãªã„å•é¡Œãƒ»å‹‰å¼·æ³•ãªã©</dd>
        </div>
        <dd class="subtopics" id="study">
          <a href="questions.html?topic=japanese">å›½èª</a>
          <a href="questions.html?topic=math">æ•°å­¦</a>
          <a href="questions.html?topic=english">è‹±èª</a>
          <a href="questions.html?topic=science">ç†è§£</a>
          <a href="questions.html?topic=socialStudies">ç¤¾ä¼š</a>
          <a href="questions.html?topic=inquiry">æ¢ç©¶</a>
          <a href="questions.html?topic=otherSubjects">å‰¯æ•™ç§‘/ãã®ä»–</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="mind">ğŸ©µ å¿ƒç†</dt>
          <dd data-topic="mind">ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="mind">
          <a href="questions.html?topic=personality">æ€§æ ¼</a>
          <a href="questions.html?topic=emotion">æ„Ÿæƒ…</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="health">ğŸ’ª å¥åº·</dt>
          <dd data-topic="health">ç¡çœ ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="health">
          <a href="questions.html?topic=lifestyle">ç”Ÿæ´»ç¿’æ…£</a>
          <a href="questions.html?topic=physicalCondition">ä½“èª¿ç®¡ç†</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="society">ğŸ‘¤ ç¤¾ä¼š</dt>
          <dd data-topic="society">äººã¥ãã‚ã„ãƒ»å­¦æ ¡è¡Œäº‹ãªã©</dd>
        </div>
        <dd class="subtopics" id="society">
          <a href="questions.html?topic=schoolLife">å­¦æ ¡ç”Ÿæ´»</a>
          <a href="questions.html?topic=relationship">äººé–“é–¢ä¿‚</a>
        </dd>

        <div class="topic-item">
          <dt class="topic" data-topic="career">ğŸ« é€²è·¯</dt>
          <dd data-topic="career">é€²å­¦å…ˆã®æ¢ã—æ–¹ãªã©</dd>
        </div>
        <dd class="subtopics" id="career">
          <a href="questions.html?topic=college">å¤§å­¦</a>
          <a href="questions.html?topic=exam">å—é¨“</a>
        </dd>
      </dl>
    </div>
  </div>

  <!-- Firebase SDK & ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, doc, collection, query, where,
      orderBy, limit, getDocs, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAgZdnJ9Tptevqoa0S46T8FxNC2zKnK7rE",
      authDomain: "my-memory-1acf4.firebaseapp.com",
      projectId: "my-memory-1acf4",
      storageBucket: "my-memory-1acf4.firebasestorage.app",
      messagingSenderId: "125628430923",
      appId: "1:125628430923:web:34b102c15d05cfb924ebce"
     };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const userIdElem = document.getElementById("user-id");
    const userPointsElem = document.getElementById("user-points");
    const logoutBtn = document.getElementById("logout-btn");

    // ğŸ”¹ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    logoutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
        window.location.href = "index.html";
      } catch (error) {
        console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });

    // ğŸ”¹ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      const userUID = user.uid;
      const userRef = doc(db, "users", userUID);

      // Firestoreã‹ã‚‰å½IDã¨ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
      onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          const fakeID = data.userID || "ä¸æ˜";
          const points = data.points || 0;
          userIdElem.textContent = `ID : ${fakeID}`;
          userPointsElem.textContent = `ãƒã‚¤ãƒ³ãƒˆ : ${points}`;
        } else {
          userIdElem.textContent = "ID : ãƒ‡ãƒ¼ã‚¿ãªã—";
          userPointsElem.textContent = "ãƒã‚¤ãƒ³ãƒˆ : ãƒ‡ãƒ¼ã‚¿ãªã—";
        }
      });

      // ğŸ”¹è‡ªåˆ†ã®è³ªå•è¡¨ç¤ºï¼ˆæœ€æ–°5ä»¶ï¼‰
      async function loadMyQuestions() {
        const answeredQuestionsElem = document.getElementById("answeredQuestions");
        const q = query(
          collection(db, "questions"),
          where("userUID", "==", userUID),
          orderBy("timestamp", "desc"),
          limit(5)
        );

        try {
          const snapshot = await getDocs(q);
          answeredQuestionsElem.innerHTML = "";

          if (snapshot.empty) {
            answeredQuestionsElem.innerHTML = "<li>ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“ã€‚</li>";
          } else {
            snapshot.forEach(docSnap => {
              const data = docSnap.data();
              const a = document.createElement("a");
              a.href = `question.html?id=${docSnap.id}`;
              a.className = "question-box";

              const p = document.createElement("p");
              p.className = "question-title";
              p.textContent = data.title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";

              a.appendChild(p);
              const li = document.createElement("li");
              li.appendChild(a);
              answeredQuestionsElem.appendChild(li);
            });
          }
        } catch (e) {
          console.error("è³ªå•å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
          answeredQuestionsElem.innerHTML = "<li>è³ªå•ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</li>";
        }
      }

      // ğŸ”¹æœªå›ç­”ã‹ã¤ä»–äººã®è³ªå• â†’ ç­”ãˆã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ
      async function loadUnansweredQuestions() {
        const listElem = document.getElementById("questionList");
        try {
          const questionsRef = collection(db, "questions");
          const q = query(
            questionsRef,
            where("answerCount", "==", 0)
            // .limit(100) // å¿…è¦ã«å¿œã˜ã¦æœ€å¤§ä»¶æ•°ã‚’åˆ¶é™ã™ã‚‹å ´åˆ
          );

          const snapshot = await getDocs(q);

          const unanswered = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(q => q.userUID !== userUID);

          if (unanswered.length === 0) {
            listElem.innerHTML = "<li>ã¾ã ç­”ãˆã¦ã»ã—ã„è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
            return;
          }

          // JSã§ãƒ©ãƒ³ãƒ€ãƒ ã«3ä»¶é¸ã¶
          const shuffled = unanswered.sort(() => Math.random() - 0.5);
          const toShow = shuffled.slice(0, 3);

          listElem.innerHTML = "";
          toShow.forEach(q => {
            const a = document.createElement("a");
            a.href = `question.html?id=${q.id}`;
            a.className = "question-box";

            const p = document.createElement("p");
            p.className = "question-title";
            p.textContent = q.title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";

            a.appendChild(p);
            const li = document.createElement("li");
            li.appendChild(a);
            listElem.appendChild(li);
          });

        } catch (error) {
          console.error("æœªå›ç­”è³ªå•ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          listElem.innerHTML = "<li>è³ªå•ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</li>";
        }
      }

      loadMyQuestions();
      loadUnansweredQuestions();
    });

    // ğŸ”¹ãƒˆãƒ”ãƒƒã‚¯å±•é–‹å‡¦ç†
    document.addEventListener("DOMContentLoaded", () => {
      const topics = document.querySelectorAll(".topic, dd[data-topic]");
      topics.forEach(item => {
        item.addEventListener("click", function () {
          const subtopics = document.getElementById(this.dataset.topic);
          if (subtopics) subtopics.classList.toggle("show");
        });
      });
    });
  </script>
</body>
</html>
